<!-- Copyright 2010 Google Inc.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

     http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->
{% extends "app/base1col.html" %}

{% block extra_head %}

<script LANGUAGE='JavaScript'>
goog.require('goog.json');
goog.require('goog.net.XhrIo');
goog.require('goog.ui.Dialog');
goog.require('goog.dom');

</script>
 <style>
  .modal-dialog {
    width: 400px;
  }
  </style>
{% endblock %}

{% block title %} {{ title }} {% endblock %}

{% block content_main %}
{% if errorMsg %}
  {{errorMsg}}
  <hr/>
{% endif %}
 <form id='edit_form' action='/submitEdits' method='POST' enctype="application/octet-stream">
 <table class='commonAttributes' width='50%'> 
 {% if trunk_id %}
 <input type='hidden' name='trunk_id' value='{{trunk_id}}'>
 {% endif %}
 {% if doc_id %}
 <input type='hidden' name='doc_id' value='{{doc_id}}'>
 {% endif %}
 <tr><td><b>Creator : </b></td><td>{{doc.creator}}</td></tr>
 <tr><td><b>Created on : </b></td><td>{{doc.created}}</td></tr>
 <tr><td><b>Title: </b></td><td><input type='text' name='doc_title'/></td></tr>
 <tr><td><b>Label: </b></td><td><select name='doc_label'>
  {% for label in allowed_labels %}
  {% ifequal label doc.label %}
  <option value='{{label}}' selected>{{label}}</option>
  {% else %}
  <option value='{{label}}'>{{label}}</option>
  {% endifequal %}
  {% endfor %}
 <tr><td><b>Grade Level: </b></td><td><select name='doc_grade_level'>
 {% for i in data_valid_range %}
 {% ifequal i doc.grade_level %}
 <option value={{i}} selected>{{i}}</option>
 {% else %}
 <option value={{i}}>{{i}}</option>
 {% endifequal %}
 {% endfor %}
 </td>
</tr>
 </table>
 <hr/>
 <font align='right'>
 <input type='submit' value='submit'>
 </font>
 <center>
 <table class='addItem' id='content_table'>
 {% if doc_contents %}
 {% for object in doc_contents %}
  <tr class={% cycle '"oddrow"' '"evenrow"' %} id='{{ object|get_key }}'>
  {% ifequal object|class_name "RichTextModel" %}
  <td><div>{% include 'include/edit_rich_text_model.html' %}<hr></div></td>
  {% else %}
   {% ifequal object|class_name "VideoModel" %}
     <td><div>{% include 'include/edit_video_model.html' %}<hr></div></td>
   {% else %}
   {% ifequal object|class_name "DocLinkModel" %}
  <td><div>{% include 'include/edit_doc_link_model.html' %}<hr></div></td>
   {% else %}
   {% ifequal object|class_name "WidgetModel" %}
  <td><div>{% include 'include/edit_widget_model.html' %}<hr></div></td>

   {% endifequal %}
   {% endifequal %}
   {% endifequal %}
 {% endifequal %}
  <td><b><a href="javascript:deleteRow('{{ object|get_key }}');">Delete</a></b></td>
</tr>
{% endfor %}
{% endif %}
<tr id='object_menu'><td><b>Add Item:</b></td><td><select id='object_type' width='10'>
 <option value='None'>---</option>
 <option value='rich_text'>Html Text</option>
 <option value='doc_link'>Link</option>
 <option value='video'>Video</option>
 <option value='widget'>Quiz</option>
 <option value='widget'>Widget</option></td></tr>
</table>
 </center>
 </form>

<script type="text/javascript">
 var global_counter = 0;
 var xhr = new goog.net.XhrIo();
 var linkDialog = new goog.ui.Dialog(null, true);
    linkDialog.setTitle('Link Picker');

 
 launchPicker = function(){
    url = '/getListAjax'
    goog.events.removeAll(xhr);
    goog.events.listen(xhr, goog.net.EventType.COMPLETE,
                       process_list);

    xhr.send(url);
 }
 deleteRow = function(passed_id) {
   element =  document.getElementById(passed_id);
   if (element) {
     goog.dom.removeChildren(element);
   }
 }

 pickLink = function(trunk_id, doc_id, title){
  ++global_counter;
  var link = '/view?trunk_id='+ trunk_id +'&doc_id='+ doc_id;
  var table_body = document.getElementById('content_table');
  var new_row = document.createElement("TR");
  new_row.id = 'content_row'+global_counter;
  var col1 = document.createElement("TD");
  var bTag = document.createElement("B");
  var col2 = document.createElement("TD");
  var att_name = "data_val";
  var iElement2 = document.createElement("Input"); 
  iElement2.setAttribute('type', "hidden");
  iElement2.setAttribute('name', "data_type");
  iElement2.value = 'doc_link';
  var iElement1 = document.createElement("Input");
  iElement1.setAttribute('type', 'hidden');
  iElement1.value = link;
  bTag.appendChild(document.createTextNode('Link: '));
  iElement1.setAttribute('name', att_name);
  element3 = document.createElement("DIV");
  element3.innerHTML = '<a href="' + link +'">'+title + '</a>'+
      '<input type="hidden" name="data_height" value="0">'+
      '<input type="hidden" name="data_width" value="0">' +
      '<input type="hidden" name="data_title" value="">';
  col1.appendChild(bTag)
  col2.appendChild(element3)
  col2.appendChild(iElement1)
  col2.appendChild(iElement2)
  var col3 = document.createElement("TD");
  col3.innerHTML = '<b><a href="javascript:deleteRow(\'content_row'+ global_counter + '\');">Delete</a></b>';
  
    new_row.appendChild(col1);
    new_row.appendChild(col2);
    new_row.appendChild(col3);
    var el1 = document.getElementById('object_menu')
    el1.parentNode.insertBefore(new_row,el1);
    linkDialog.setVisible(false);
 }

 process_list = function(){
    obj = xhr.getResponseJson();
    dialogHtml = '<table width="100%">';
    for (var i=0; i<obj.doc_list.length ; i++)
    {
       dialogHtml += '<tr><td><a href="javascript:pickLink(\''+obj.doc_list[i].trunk_id+'\',\''+ obj.doc_list[i].doc_id+'\',\'' + obj.doc_list[i].doc_title+'\');">'+
                   obj.doc_list[i].doc_title +'</td><td><input type="button" onclick="javascript:window.open(\'/view?trunk_id='+ obj.doc_list[i].trunk_id +
                     '&doc_id='+ obj.doc_list[i].doc_id +'&absloute=True\');" value="Preview"/></td></tr>';
    }
    dialogHtml += '</table>';
    linkDialog.setContent(dialogHtml)
    linkDialog.setVisible(true);
 }

 function add_content(value_passed){
    /*
     *@param
     *  value_passed: type of object selected for insertion
     */
    
    ++global_counter
    var table_body = document.getElementById('content_table');
    var new_row = document.createElement("TR");
    new_row.id = 'content_row'+global_counter;
    var col1 = document.createElement("TD");
       
    if (value_passed == 'rich_text'){
       var iElement = document.createElement("DIV");
       var inputHtmlArray = 
           ['<table><tr><td><b>HTML Text: </b></td>','<td><textarea ',
            'rows="8" cols="60" name="data_val"/></textarea>',
            '<input type="hidden" name="data_type" value="rich_text"/>',
            '<input type="hidden" name="data_height" value="0"/>',
            '<input type="hidden" name="data_width" value="0"/>',
            '<input type="hidden" name="data_title" value="no title"/>',
            '</td></tr></table><hr/>',
            ];
       iElement.innerHTML = inputHtmlArray.join('');

    } else if (value_passed == 'video') {
       var iElement = document.createElement("DIV");
       var inputHtmlArray = 
           ['<table><tr><td><b>Video Id: </b></td>','<td><input type="text" ',
            'name="data_val"/></td></tr>','<tr><td><b>Video Height: </b></td>',
            '<td><input type="text" name="data_height" value="300"/></td></tr>',
            '<td><b>Video Width: </b></td>','<td><input type="text"',
            'name="data_width" value="600"/></td></tr>','<td><b>Video Title: </b></td>',
            '<td><input type="hidden" name="data_type" value="',value_passed,'">',
            '<input type="text" ', 'name="data_title"/></td></tr></table>','<hr/>'];
       iElement.innerHTML = inputHtmlArray.join('');
    } else if (value_passed == 'py_shell'){
    } else if (value_passed == 'quiz') {
    } else if (value_passed == 'widget') {
       var iElement = document.createElement("DIV");
       var inputHtmlArray = 
           ['<table><tr><td><b>Quiz/Widget Link: </b></td>','<td><input type="text" ',
            'name="data_val"/></td></tr>','<tr><td><b>Widget Height: </b></td>',
            '<td><input type="text" name="data_height" value="400px"/></td></tr>',
            '<td><b>Widget Width: </b></td>','<td><input type="text"',
            'name="data_width" value="100%"/></td></tr>','<td><b>Widget Title: </b></td>',
            '<td><input type="hidden" name="data_type" value="',value_passed,'">',
            '<input type="text" ', 'name="data_title"/></td></tr></table>','<hr/>'];
       iElement.innerHTML = inputHtmlArray.join('');

    }
    else {
          alert('wrong value') 
    } 
    col1.appendChild(iElement)
    var col2 = document.createElement("TD");
    col2.innerHTML = '<b><a href="javascript:deleteRow(\'content_row'+ 
                     global_counter + '\');">Delete</a></b>';

    new_row.appendChild(col1);
    new_row.appendChild(col2);
    var el1 = document.getElementById('object_menu')
    el1.parentNode.insertBefore(new_row,el1);
} 


 var edit_menu = document.getElementById("object_type")
 edit_menu.onchange = function(){ 
  var option = this.options[this.selectedIndex];
  this.selectedIndex = 0
  if (option.value == 'doc_link'){
    launchPicker();
          return;
  }
  else {
    add_content(option.value)
  }
 }

</script>
{% endblock %}
